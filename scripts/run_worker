#!/bin/bash
#
# Run worker with correct logging and DB setting.
#
# Usage: sudo -u khresmoi run_worker [-r]
#
# -r = Force restart
#


MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
. $MYDIR/../config/init.sh

if [ "$1" == '-r' ]; then
    echo "Killing existing worker..."
    for i in `ps ax | grep "$VERSION.*/worker.py" | sed 's/\s.*//'`; do 
        kill $i; 
    done
    sleep 5
fi

. ~$USER/virtualenv/bin/activate
. ~$USER/mt-$VERSION/config/config_worker.sh

cd ~$USER/mt-$VERSION/logs
nohup python ~$USER/mt-$VERSION/worker/worker.py >> ~$USER/mt-$VERSION/logs/worker.log 2>&1 &
